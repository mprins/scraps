<html>
  <head>
    <title>WebNN Conv2D</title>
  </head>
  <body>
    <canvas id="input" width="500" height="500"></canvas>
    <canvas id="output" width="500" height="500"></canvas>
    <script>
      const channels = 4;

      async function createGraph(context) {
        const builder = new MLGraphBuilder(context);
        const filterWidth = 10;
        const filterHeight = 10;
        const input = builder.input(
            'input', {dataType: 'float32', dimensions: [1, 500, 500, channels]});
        const filterData = new Float32Array(filterWidth * filterHeight * channels);
        filterData.fill(1 / (filterWidth * filterHeight));
        const filter = builder.constant(
            {dataType: 'float32', dimensions: [1, filterWidth, filterHeight, channels]},
            filterData);
        const output = builder.conv2d(input, filter, {
            inputLayout: 'nhwc',
            filterLayout: 'ihwo',  // IHWO is required for depthwise convolution.
            groups: channels,  // Convolve each input channel with its own filter.
        });
        return {
          graph: await builder.build({'output': output}),
          outputHeight: output.shape()[1],
          outputWidth: output.shape()[2],
        }
      }

      function imageDataToTensor(imageData) {
        const tensor = new Float32Array(imageData.data.length);
        for (let i = 0; i < imageData.data.length; ++i) {
          tensor[i] = imageData.data[i] / 256;
        }
        return tensor;
      }

      function tensorToImageData(tensor, width, height) {
        const imageData = new ImageData(width, height);
        for (let i = 0; i < tensor.length; ++i) {
          imageData.data[i] = tensor[i] * 256;
        }
        return imageData;
      }

      async function runConvolution(inputData) {
        const context = await navigator.ml.createContext({deviceType: 'cpu'});
        const {graph, outputWidth, outputHeight} = await createGraph(context);

        const input = imageDataToTensor(inputData);
        const output = new Float32Array(outputWidth * outputHeight * channels);

        const {inputs, outputs} = await context.compute(graph, {input}, {output});

        return tensorToImageData(outputs.output, outputWidth, outputHeight);
      }

      const image = new Image();
      image.onload = async () => {
        const inputCanvas = document.getElementById('input');
        const inputCtx = inputCanvas.getContext('2d');
        inputCtx.drawImage(image, 0, 0);
        const inputData = inputCtx.getImageData(0, 0, image.width, image.height);

        const outputData = await runConvolution(inputData);
        const outputCanvas = document.getElementById('output');
        const outputCtx = outputCanvas.getContext('2d');
        outputCtx.putImageData(outputData, 0, 0);
      };
      image.src = 'photo.jpg';
    </script>
  </body>
</html>